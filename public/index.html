<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>CRUD de Produtos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>CRUD de Produtos</h1>
    <div>
      <span id="expiracao" class="me-3 text-muted"></span>
      <button class="btn btn-danger" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-success text-white">Cadastro / Edição de Produto</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-2">
          <label class="form-label">ID</label>
          <input id="id" class="form-control" placeholder="ID" disabled>
        </div>
        <div class="col-md-4">
          <label class="form-label">Nome</label>
          <input id="nome" class="form-control" placeholder="Nome">
        </div>
        <div class="col-md-3">
          <label class="form-label">Preço</label>
          <input id="preco" class="form-control" placeholder="Preço">
        </div>
        <div class="col-md-12">
          <label class="form-label">Descrição</label>
          <input id="descricao" class="form-control" placeholder="Descrição">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-success me-2" onclick="salvar()">Salvar</button>
        <button class="btn btn-secondary" onclick="limparFormulario()">Limpar</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header bg-info text-white">Lista de Produtos</div>
    <div class="card-body">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Preço</th>
            <th>Descrição</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const token = localStorage.getItem('token');
const expiracao = localStorage.getItem('expiracao');

if (!token) {
  window.location.href = 'login.html';
} else {
  document.getElementById('expiracao').innerText = `Token expira em: ${expiracao}`;
}

function verificarErroDeAutenticacao(res) {
  if (res.status === 401 || res.status === 403) {
    Swal.fire('Sessão expirada', 'Faça login novamente.', 'warning')
      .then(() => {
        logout();
      });
    throw new Error('Token inválido ou expirado');
  }
  return res;
}

function logout() {
  localStorage.removeItem('token');
  localStorage.removeItem('expiracao');
  window.location.href = 'login.html';
}

function listar() {
  fetch('/api/produtos', {
    headers: { Authorization: token }
  })
    .then(verificarErroDeAutenticacao)
    .then(r => {
      if (!r.ok) throw new Error('Falha ao listar');
      return r.json();
    })
    .then(produtos => {
      const lista = document.getElementById('lista');
      lista.innerHTML = '';
      produtos.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.nome}</td>
          <td>R$ ${p.preco}</td>
          <td>${p.descricao}</td>
          <td>
            <button class='btn btn-sm btn-warning me-2' onclick='editar(${JSON.stringify(p)})'>Editar</button>
            <button class='btn btn-sm btn-danger' onclick='deletar(${p.id})'>Excluir</button>
          </td>
        `;
        lista.appendChild(tr);
      });
    })
    .catch(err => {
      Swal.fire('Erro', 'Erro ao listar: ' + err.message, 'error');
    });
}

function salvar() {
  const id = document.getElementById('id').value;
  const nome = document.getElementById('nome').value;
  const preco = parseFloat(document.getElementById('preco').value);
  const descricao = document.getElementById('descricao').value;

  if (!nome || isNaN(preco)) {
    Swal.fire('Atenção', 'Preencha os campos corretamente.', 'warning');
    return;
  }

  const produto = { nome, preco, descricao };
  const url = id ? `/api/produtos/${id}` : '/api/produtos';
  const method = id ? 'PUT' : 'POST';

  fetch(url, {
    method,
    headers: {
      'Content-Type': 'application/json',
      Authorization: token
    },
    body: JSON.stringify(produto)
  })
    .then(verificarErroDeAutenticacao)
    .then(r => {
      if (!r.ok) throw new Error('Erro ao salvar');
      return r.json();
    })
    .then(() => {
      Swal.fire('Sucesso!', 'Produto salvo com sucesso!', 'success');
      limparFormulario();
      listar();
    })
    .catch(err => {
      Swal.fire('Erro', 'Erro ao salvar: ' + err.message, 'error');
    });
}

function editar(produto) {
  document.getElementById('id').value = produto.id;
  document.getElementById('nome').value = produto.nome;
  document.getElementById('preco').value = produto.preco;
  document.getElementById('descricao').value = produto.descricao;
}

function deletar(id) {
  Swal.fire({
    title: 'Tem certeza?',
    text: 'Você não poderá reverter isso!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Sim, excluir!',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/api/produtos/${id}`, {
        method: 'DELETE',
        headers: { Authorization: token }
      })
        .then(verificarErroDeAutenticacao)
        .then(r => {
          if (!r.ok) throw new Error('Erro ao excluir');
          return r.json();
        })
        .then(() => {
          Swal.fire('Excluído!', 'Produto excluído com sucesso.', 'success');
          listar();
        })
        .catch(err => {
          Swal.fire('Erro', 'Erro ao excluir: ' + err.message, 'error');
        });
    }
  });
}

function limparFormulario() {
  document.getElementById('id').value = '';
  document.getElementById('nome').value = '';
  document.getElementById('preco').value = '';
  document.getElementById('descricao').value = '';
}

listar();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
